%!TEX root = main.tex

%For simplicity, we assume that $\Mm$ contains $\standard$ and $\singletask$ activities only. 
%The proof of Theorem~\ref{thm:st-amass-reach} is technically the most challenging part of this paper. 
%To ease the understanding, we shall prove the configuration reachability problem of $\STK$-dominating $\LMAMASS$ (resp. $\STK$-dominating $\IFAMASS$) is decidable in Section~\ref{sec:reach-lmamass} (resp. Section~\ref{sec:reach-ifamass}) first, then prove the configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable in Section~\ref{sec:reach-amass}.


% Following the same approach as the semantic definition, we address the problem step by step in these three scenarios, i.e., $\LMAMASS$, $\IFAMASS$ and {\AMASS}.
% To tackle the configuration reachability problem for $\STK$-dominating $\AMASS$, we consider three case, i.e., 
% $(A,\STK(A'))\notin\Delta$, $\lmd(A_0)=\singletask$ and $\lmd(A_0)\neq\singletask$. 


\section{Configuration reachability problem of $\AMASS$}\label{sec-conf-reach}

In this paper, we focus on the configuration reachability problem of $\AMASS$. This problem is fundamental to the formal (static) analysis and verification of the behaviors of Android apps with respect to the multitasking mechanism.  

Let $\Mm =(\act, A_0, \lmd, \aft, \Delta)$ be an  {\AMASS}. Then we define $\RConfs(\Mm)$ as the set of configurations $\rho$ that are reachable from the initial configuration, that is, 
$(A_0, \aft(A_0)) \xRightarrow[\Mm]{} \rho$. 
Let $(\Aut_1,\cdots,\Aut_k)$ be an {\NFA} tuple over the alphabet $\act$. We define $\Rel((\Aut_1, \cdots, \Aut_k))$ as $(S_1, \cdots, S_k)$ such that for each $i \in [k]$, $S_i \in \Lang(\Aut_i)$. Moreover, let $\theta = \aname_1\cdots\aname_k$ be an affinity sequence. Then $\confs((\theta, (\Aut_1,\cdots,\Aut_k)))$, \emph{the set of configurations accepted by $(\theta, (\Aut_1,\cdots,\Aut_k))$}, is defined as as the set of configurations $\rho = ((S_1,\aname'_1),\cdots,(S_k,\aname'_k))$  such that $(S_1, \cdots, S_k) \in \Rel((\Aut_1, \cdots, \Aut_k))$, and for each $i \in [k]$, $\aname_i=\aname_i'$.
%
% $\confs((\theta, (\Aut_1,\cdots,\Aut_k)))$, \emph{the set of configurations accepted by $(\theta, (\Aut_1,\cdots,\Aut_k))$}, as the set of configurations $\rho = ((S_1,\aname'_1),\cdots,(S_k,\aname'_k))$  such that for each $i \in [k]$, $\aname_i=\aname_i'$ and $S_i \in \Lang(\Aut_i)$. 
Then \emph{the configuration reachability problem} of {\AMASS} is defined as follows. 
\begin{quote}
Given an {\AMASS} $\Mm= (\act, A_0, \lmd, \aft, \Delta)$, an affinity sequence $\theta = \aname_1\cdots\aname_k$, and an {\NFA} tuple $(\Aut_1,\cdots,\Aut_k)$ over the alphabet $\act$, decide whether $ \confs({(\theta, (\Aut_1,\cdots,\Aut_k))}) \cap \RConfs(\Mm) \neq \emptyset$.
\end{quote}

As we have seen, the semantics of {\AMASS} in Section~\ref{sec:amass} is rather complicated. Therefore, it is highly challenging to achieve a decision procedure for the configuration reachability problem of {\AMASS}. In this paper, we restrict our attention to a sub-model of {\AMASS}, called $\STK$-dominating {\AMASS}, and design a decision procedure for it. We shall see later on that the decision procedure for the sub-model is already quite involved and requires nontrivial novel ideas.  

%Due to the semantics of {\AMASS} defined in Section~\ref{sec:semantics-amass} is highly complicated, it is difficult to provide a decision algorithm for solving the configuration reachability problem of {\AMASS}. To this end, we introduce a fragment of {\AMASS} called STK-dominating {\AMASS}, which accommodates all launch mdoes and intent flags. 

\begin{definition}[$\STK$-dominating \AMASS] \label{def:stk-amass}
    An $\AMASS$  $\Mm = (\act, A_0, \lmd, \aft, \Delta)$ is said to be \emph{$\STK$-dominating} if the following constraints are satisfied.
    \begin{enumerate}
		\item $\back\in\Delta$,
        \item the task affinities of $\singletask$-activities (if there is any) are mutually distinct,
%        \item for each transition $A \xrightarrow{\startactivity(\phi)} B\in\Delta$ such that $A\in\act_{\singleinstance}$, it holds that $B\in\act_{\singleinstance}\cup\act_{\singletask}$,
        \item for each transition $A \xrightarrow{\startactivity(\phi)} B\in\Delta$ such that $A \in \act_\singleinstance$ or $\phi\models \ntkflag$, we have $B \in \act_{\singleinstance} \cup \act_{\singletask}$.
    \end{enumerate}
\end{definition}
Intuitively, in an $\STK$-dominating $\AMASS$ $\Mm$, the task creation or task switching actions are all triggered by the $\singleinstance$ or $\singletask$ launch mode, more precisely,  
each task of $\Mm$ contains at most one $\STK$-activity, moreover, whenever a task creation or task switching action occurs, the launched activity is of $\singleinstance$ or $\singletask$ launch mode, equivalently speaking, 
whenever an $\standard$ or $\singletop$-activity is started, no task creation or task switching actions occur.  %This intuition is formalized by the proposition below.
%For the two sub-models of $\AMASS$, i.e., $\LMAMASS$ and $\IFAMASS$, an $\LMAMASS$ (resp. $\IFAMASS$) is said to be $\STK$-dominating if the above four constraints are satisfied.

\begin{example}
	We will use the following three examples to illustrate the concept of $\STK$-dominating $\AMASS$. \zhilin{the example to be cleaned}
	%, $\STK$-dominating $\IFAMASS$ and $\STK$-dominating $\AMASS$ respectively.

Let $\Mm_{\textsf{LM}}=(\act_{\textsf{LM}},A_0,\lmd_{\textsf{LM}},\aft_{\textsf{LM}},\Delta_{\textsf{LM}})$ be an $\STK$-dominating $\LMAMASS$, where $\act_{\textsf{LM}} = \{A_0, A_1,B_0,B_1\}$, the functions $\lmd_{\textsf{LM}}$ and $\aft_{\textsf{LM}}$ are defined in Table~\ref{tab-attribute-stk}.
\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|c|c|c|c|c|c|}
	\hline
	Activity & $\lmd_{\textsf{LM}}$ & $\aft_{\textsf{LM}}$\\
	\hline
	$A_0$ & $\STD$ & 0\\
	\hline
	$A_1$ & $\STD$ & 1 \\
	\hline
	$B_0$ & $\STK$ & 0 \\
	\hline
	$B_1$ & $\STK$ & 1 \\
	\hline
	\end{tabular}
	\caption{Attributes of activities}
	\label{tab-attribute-stk}
	\end{center}
\end{table}
		
Moreover, $\Delta_{\textsf{LM}} = \{\back,\tau_1, \tau_2, \tau_3, \tau_4, \tau_5\}$, where 
		$\tau_1 = A_0 \xrightarrow{\startactivity(\bot)} B_0$,
		$\tau_2 = A_0 \xrightarrow{\startactivity(\bot)} B_1$,
		$\tau_3 = A_1 \xrightarrow{\startactivity(\bot)} B_0$.
		$\tau_4 = B_0 \xrightarrow{\startactivity(\bot)} A_0$,
		$\tau_5 = B_1 \xrightarrow{\startactivity(\bot)} A_1$,
	Then the configurations that are reachable from the initial configuration $(([A_0], 0))$ by executing the transition rules from $\Delta_{\textsf{LM}}$ are illustrated in Figure~\ref{stk-lmasm-example}, where the vertices denote the configurations and the edges denote the elements of $\xrightarrow[\Mm_{\textsf{LM}}]{}$. 
	For instance, 
	\begin{itemize}
	\item if $A_0 \xrightarrow{\startactivity(\bot)} B_1$ is applied to the configuration $(([A_0],0))$, then a new task $([B_1],1)$ is created, since $\lmd_{\textsf{LM}}(B_1) = \STK$ and $\gettsk((([A_0],0)), B_1) = *$, resulting to the configuration $(([B_1],1),([A_0],0))$,
	%
	\item if $A_1 \xrightarrow{\startactivity(\bot)} B_0$ is applied to the configuration $(([A_1B_1],1),([A_0B_0A_0],0))$, then the task $([A_0B_0A_0],0)$ is moved to the top and all the activities above $B_0$, which is $A_0$ here, are removed from the task, since $\lmd_{\textsf{LM}}(B_0) = \STK$,
	$$\gettsk((([A_1B_1],1),([A_0B_0A_0],0)), B_0) = ([A_0B_0A_0],0)$$
	and $B_0$ occurs in $([A_0B_0A_0],0)$, resulting to the configuration $(([B_0A_0],0),([A_1B_1],1))$,
	%
	\item if $A_1 \xrightarrow{\startactivity(\bot)} B_0$ is applied to the configuration $(([A_1B_1],1),([A_0B_0],0))$, then the task $([A_0B_0],0)$ is moved to the top and all the activities above $B_0$, which is $A_0$ here, are removed from the task, since $\lmd_{\textsf{LM}}(B_0) = \STK$,
	$$\gettsk((([A_1B_1],1),([A_0B_0],0)), B_0) = ([A_0B_0],0)$$
	and $B_0$ occurs in $([A_0B_0],0)$, resulting to the configuration $(([B_0],0),([A_1B_1],1))$,
	%
	\item if $A_1 \xrightarrow{\startactivity(\bot)} B_0$ is applied to the configuration $(([A_1B_1],1),([A_0],0))$, then the task $([A_0],0)$ is moved to the top and $B_0$ is pushed to the task, since $\lmd_{\textsf{LM}}(B_0) = \STK$,
	$$\gettsk((([A_1B_1],1),([A_0],0)), B_0) = ([A_0],0)$$
	and $B_0$ does not occur in $([A_0],0)$, resulting to the configuration $(([B_0A_0],0),([A_1B_1],1))$,
	%
	\item if $\back$ is applied to the configuration $(([B_0A_0], 0))$, then $B_0$ is removed from the task, since $|[B_0A_0]|  > 1$, resulting to the configuration $(([A_0], 0))$,
	%
	\item if $\back$ is applied to the configuration $(([B_1],1),([A_0B_0A_0],0))$, then the task $([B_1], 1)$ is removed, since $|[B_1]| = 1$, resulting to the configuration $(([A_0B_0A_0], 0))$,

	\end{itemize}
	Note that for $\Mm_{\textsf{LM}}$, there are only finitely many configurations reachable from the initial configuration, which may not be the case for $\STK$-dominating $\LMAMASS$ in general.  
	\begin{figure}
		% \vspace{-3mm}
			\centering
			\includegraphics[scale = 0.55]{stk-lmasm-example.pdf}
			\caption{Configurations reachable from the initial configuration $(([A_0], 0))$ in the $\STK$-dominating $\LMAMASS$ $\Mm_{\textsf{LM}}$}
				%in $\phi$
		% \vspace{-6mm}	
		\label{stk-lmasm-example}
	\end{figure}

Let $\Mm_{\textsf{IF}}=(\act_{\textsf{IF}},A,\lmd_{\textsf{IF}},\aft_{\textsf{IF}},\Delta_{\textsf{IF}})$ be an $\STK$-dominating $\IFAMASS$, where $\act_{\textsf{IF}} = \{A, B\}$, and $\lmd_{\textsf{IF}}(A) = \lmd_{\textsf{IF}}(B) = \STD$, $\aft_{\textsf{IF}}(A) = \lmd_{\textsf{IF}}(B) = 1$.
	Moreover, $\Delta_{\textsf{IF}} = \{\back, \tau_1, \tau_2, \tau_3 \}$, where 
	$\tau_1 = A\xrightarrow[]{\startactivity(\bot)}B$,
	$\tau_2 = B\xrightarrow[]{\startactivity(\bot)}A$,
	$\tau_2 = B\xrightarrow[]{\startactivity(\rtfflag)}A$.
	Then the configurations that are reachable from the initial configuration $[A]$ by executing the transition rules from $\Delta_{\textsf{IF}}$ are illustrated in Figure~\ref{stk-ifasm-example}, where the vertices denote the configurations and the edges denote the elements of $\xrightarrow[\Mm_{\textsf{IF}}]{}$. 
	For instance, 
	\begin{itemize}
	\item if $B \xrightarrow{\startactivity(\rtfflag)} A$ is applied to the configuration $[B]$, then $A$ is pushed to the task, since $\phi\models\rtfflag$ and $A$ dose not occur in the task $[B]$, resulting to the configuration $[AB]$,
	%
	\item if $B \xrightarrow{\startactivity(\rtfflag)} A$ is applied to the configuration $[BA]$, then $A$ is moved to the top of the task, since $\phi\models\rtfflag$ and $A$ occurs in the task $[BA]$, resulting to the configuration $[AB]$,
	%
	\item if $B \xrightarrow{\startactivity(\rtfflag)} A$ is applied to the configuration $[BABA]$, then the topmost $A$ is moved to the top of the task, since $\phi\models\rtfflag$ and $A$ occurs in the task $[BABA]$, resulting to the configuration $[ABBA]$,
	%

	\end{itemize}
	Note that for $\Mm_{\textsf{IF}}$, there are infinite many configurations reachable from the initial configuration. Therefore, we will only display configurations with a length no greater than $4$.

	\begin{figure}
		% \vspace{-3mm}
			\centering
			\includegraphics[scale = 0.65]{stk-ifasm-example.pdf}
			\caption{Configurations reachable from the initial configuration $[A]$ in the $\STK$-dominating $\IFAMASS$ $\Mm_{\textsf{IF}}$}
				%in $\phi$
		% \vspace{-6mm}	
		\label{stk-ifasm-example}
	\end{figure}

Let $\Mm=(\act_{\textsf{LM}},A_0,\lmd_{\textsf{LM}},\aft_{\textsf{LM}},\Delta)$ be an $\STK$-dominating $\AMASS$, where $\Delta = \{\back,\tau_1, \tau_2, \tau_3, \tau_4, \tau_5\}$, where 
		$\tau_1 = A_0 \xrightarrow{\startactivity(\bot)} A_1$,
		$\tau_2 = A_1 \xrightarrow{\startactivity(\bot)} B_0$,
		$\tau_3 = B_0 \xrightarrow{\startactivity(\rtfflag)} A_1$,
		$\tau_4 = A_1 \xrightarrow{\startactivity(\bot)} B_1$,
		$\tau_5 = B_1 \xrightarrow{\startactivity(\bot)} B_0$.
	Then the configurations that are reachable from the initial configuration $(([A_0], 0))$ by executing the transition rules from $\Delta$ are illustrated in Figure~\ref{stk-asm-example}, where the vertices denote the configurations and the edges denote the elements of $\xrightarrow[\Mm]{}$. 
	For instance, 
	\begin{itemize}
	\item if $B_0 \xrightarrow{\startactivity(\rtfflag)} A_1$ is applied to the configuration $(([B_0A_1A_0],0),([B_1],1))$, then $A_1$ is moved to the top of the top task $([B_0A_1A_0],0)$, since $\phi\models\rtfflag$ and $\lmd_{\textsf{IF}}(A_1) = \STD$ and $A_1$ occurs in the task $([B_0A_1A_0],0)$, resulting to the configuration $(([A_1B_0A_0],0),([B_1],1))$,
	%
	\item if $A_1 \xrightarrow{\startactivity(\bot)} B_0$ is applied to the configuration $(([A_1B_0A_0],0),([B_1],1))$, then all the activities above $B_0$, which is $A_1$ here, are removed from the task $([A_1B_0A_0],0)$, since $\lmd_{\textsf{LM}}(B_0) = \STK$, 
	$$\gettsk((([A_1B_0A_0],0),([B_1],1)), B_0) = ([A_1B_0A_0],0)$$
	and $B_0$ occurs in the task $([A_1B_0A_0],0)$, resulting to the configuration $(([B_0A_0],0),([B_1],1))$,
	%
	\item if $B_1 \xrightarrow{\startactivity(\bot)} B_0$ is applied to the configuration $(([B_1],1),([A_1A_0], 0))$, then the task $([A_1A_0], 0)$ is moved to the top and $B_0$ is pushed to the task,
	since $\lmd_{\textsf{LM}}(B_0) = \STK$, 
	$$\gettsk((([B_1],1),([A_1A_0], 0)), B_0) = ([A_1A_0], 0)$$
	and $B_0$ dose not occur in the task $([A_1A_0], 0)$, resulting to the configuration $(([B_0A_1A_0],0),([B_1],1))$.
	\end{itemize}
	Note that for $\Mm$, there are only finitely many configurations reachable from the initial configuration, which may not be the case for $\STK$-dominating $\AMASS$ in general.  
	\begin{figure}
		% \vspace{-3mm}
			\centering
			\includegraphics[scale = 0.6]{stk-asm-example.pdf}
			\caption{Configurations reachable from the initial configuration $(([A_0], 0))$ in the $\STK$-dominating $\AMASS$ $\Mm$}
				%in $\phi$
		% \vspace{-6mm}	
		\label{stk-asm-example}
	\end{figure}

% example of STK-dominating AMASS here. \zhilin{three examples for $\LMAMASS$, $\IFAMASS$, and $\AMASS$ respectively, to be used in the decision procedure.}
\end{example}


\begin{proposition}\label{prop-stk}
    Let $\Mm=(\act,A_0,\lmd,\aft,\Delta)$ be an $\STK$-dominating $\AMASS$. Then each configuration $\rho$ that is reached from the initial configuration $(([A_0],\aft(A_0)))$ in $\Mm$ satisfies the following constraints:
    \begin{enumerate}
        \item for each $\STK$-activity $A\in\act$ with $\aft(A)\neq\aft(A_0)$, $A$ can only occur at the bottom of some task in $\rho$, 
        \item $\rho$ contains at most one $\standard/\singletop$-task, which, when it exists, has the same affinity as $A_0$.
		% \item $\SIT$ activity has the same effects with $\STK$ activity.
    \end{enumerate}
\end{proposition}

We are ready to state the main result of this paper. 

\begin{theorem}\label{thm:st-amass-reach}
The configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable.
\end{theorem}

The rest of this paper is devoted to the proof of Theorem~\ref{thm:st-amass-reach}. Since the decision procedure is involved, to ease the understanding, we present the decision procedure for $\singletask$-dominating $\LMAMASS$ first (Section~\ref{sec:reach-lmamass}), then $\singletask$-dominating $\IFAMASS$ (Section~\ref{sec:reach-ifamass}), and finally consider $\singletask$-dominating $\AMASS$ in its most general case (Section~\ref{sec:reach-amass}). 

For technical convenience, let us assume that \emph{the affinities of $\singleinstance$-activities are mutually distinct, moreover, they are different from those of the other activities}, that is, for each $A, B \in \act_\singleinstance$ with $A \neq B$, we have $\aft(A) \neq \aft(B)$, moreover, $\aft(\act_\singleinstance) \cap \aft(\act \setminus \act_\singleinstance) = \emptyset$. Note that this assumption is not a restriction, since regarding the task allocation mechanism, the affinities of $\singleinstance$-activities are redundant and independent of those of the other activities. With this assumption, the task allocation mechanism (formalized by $\gettsk(\rho, B)$) can be specified by the \emph{name function} $\namefun_B(\theta)$ defined in the sequel:  Let $\theta = \aname_1 \cdots \aname_k$ and $B \in \act$. Then $\namefun_B(\theta) = i$ if $\aft(B) = \aname_i$ for some $i \in [k]$, and $\namefun_B(\theta) = \bot$ otherwise. Note that the invariant of configurations, that is, the task affinities of every two non-$\singleinstance$ tasks are mutually distinct, guarantees the well-definedness of $\namefun_B(\theta)$.

%For simplicity, we assume that $\Mm$ contains $\standard$ and $\singletask$ activities only. 
%The proof of Theorem~\ref{thm:st-amass-reach} is technically the most challenging part of this paper. 
%To ease the understanding, we shall prove the configuration reachability problem of $\STK$-dominating $\LMAMASS$ (resp. $\STK$-dominating $\IFAMASS$) is decidable in Section~\ref{sec:reach-lmamass} (resp. Section~\ref{sec:reach-ifamass}) first, then prove the configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable in Section~\ref{sec:reach-amass}.



\section{Configuration reachability problem of $\STK$-dominating $\LMAMASS$}\label{sec:reach-lmamass}
\input{reach-lmamass.tex}

\section{Configuration reachability problem of $\STK$-dominating $\IFAMASS$}\label{sec:reach-ifamass}
\input{reach-ifamass.tex}
% \subsection{Complete case}\label{sec:complete-case}


\section{Configuration reachability problem of $\STK$-dominating $\AMASS$}\label{sec:reach-amass}
\input{reach-amass.tex}