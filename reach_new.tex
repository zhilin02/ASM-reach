%!TEX root = main.tex

%For simplicity, we assume that $\Mm$ contains $\standard$ and $\singletask$ activities only. 
%The proof of Theorem~\ref{thm:st-amass-reach} is technically the most challenging part of this paper. 
%To ease the understanding, we shall prove the configuration reachability problem of $\STK$-dominating $\LMAMASS$ (resp. $\STK$-dominating $\IFAMASS$) is decidable in Section~\ref{sec:reach-lmamass} (resp. Section~\ref{sec:reach-ifamass}) first, then prove the configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable in Section~\ref{sec:reach-amass}.


% Following the same approach as the semantic definition, we address the problem step by step in these three scenarios, i.e., $\LMAMASS$, $\IFAMASS$ and {\AMASS}.
% To tackle the configuration reachability problem for $\STK$-dominating $\AMASS$, we consider three case, i.e., 
% $(A,\STK(A'))\notin\Delta$, $\lmd(A_0)=\singletask$ and $\lmd(A_0)\neq\singletask$. 


\section{Configuration reachability problem of $\AMASS$}\label{sec-conf-reach}

In this paper, we focus on the configuration reachability problem of $\AMASS$. This problem is fundamental to the formal (static) analysis and verification of the behaviors of Android apps with respect to the multitasking mechanism.  

Let $\Mm =(\act, A_0, \lmd, \aft, \Delta)$ be an  {\AMASS}. Then we define $\RConfs(\Mm)$ as the set of configurations $\rho$ that are reachable from the initial configuration, that is, 
$(A_0, \aft(A_0)) \xRightarrow[\Mm]{} \rho$. 
Let $(\Aut_1,\cdots,\Aut_k)$ be an {\NFA} tuple over the alphabet $\act$. We define $\Rel((\Aut_1, \cdots, \Aut_k))$ as $(S_1, \cdots, S_k)$ such that for each $i \in [k]$, $S_i \in \Lang(\Aut_i)$. Moreover, let $\theta = \aname_1\cdots\aname_k$ be an affinity sequence. Then $\confs((\theta, (\Aut_1,\cdots,\Aut_k)))$, \emph{the set of configurations accepted by $(\theta, (\Aut_1,\cdots,\Aut_k))$}, is defined as as the set of configurations $\rho = ((S_1,\aname'_1),\cdots,(S_k,\aname'_k))$  such that $(S_1, \cdots, S_k) \in \Rel((\Aut_1, \cdots, \Aut_k))$, and for each $i \in [k]$, $\aname_i=\aname_i'$.
%
% $\confs((\theta, (\Aut_1,\cdots,\Aut_k)))$, \emph{the set of configurations accepted by $(\theta, (\Aut_1,\cdots,\Aut_k))$}, as the set of configurations $\rho = ((S_1,\aname'_1),\cdots,(S_k,\aname'_k))$  such that for each $i \in [k]$, $\aname_i=\aname_i'$ and $S_i \in \Lang(\Aut_i)$. 
Then \emph{the configuration reachability problem} of {\AMASS} is defined as follows. 
\begin{quote}
Given an {\AMASS} $\Mm= (\act, A_0, \lmd, \aft, \Delta)$, an affinity sequence $\theta = \aname_1\cdots\aname_k$, and an {\NFA} tuple $(\Aut_1,\cdots,\Aut_k)$ over the alphabet $\act$, decide whether $ \confs({(\theta, (\Aut_1,\cdots,\Aut_k))}) \cap \RConfs(\Mm) \neq \emptyset$.
\end{quote}

As we have seen, the semantics of {\AMASS} in Section~\ref{sec:amass} is rather complicated. Therefore, it is highly challenging to achieve a decision procedure for the configuration reachability problem of {\AMASS}. In this paper, we restrict our attention to a sub-model of {\AMASS}, called $\STK$-dominating {\AMASS}, and design a decision procedure for it. We shall see later on that the decision procedure for the sub-model is already quite involved and requires nontrivial novel ideas.  

%Due to the semantics of {\AMASS} defined in Section~\ref{sec:semantics-amass} is highly complicated, it is difficult to provide a decision algorithm for solving the configuration reachability problem of {\AMASS}. To this end, we introduce a fragment of {\AMASS} called STK-dominating {\AMASS}, which accommodates all launch mdoes and intent flags. 

\begin{definition}[$\STK$-dominating \AMASS] \label{def:stk-amass}
    An $\AMASS$  $\Mm = (\act, A_0, \lmd, \aft, \Delta)$ is said to be \emph{$\STK$-dominating} if the following constraints are satisfied.
    \begin{enumerate}
		\item $\back\in\Delta$,
        \item the task affinities of $\singletask$-activities (if there is any) are mutually distinct,
%        \item for each transition $A \xrightarrow{\startactivity(\phi)} B\in\Delta$ such that $A\in\act_{\singleinstance}$, it holds that $B\in\act_{\singleinstance}\cup\act_{\singletask}$,
        \item for each transition $A \xrightarrow{\startactivity(\phi)} B\in\Delta$ such that $A \in \act_\singleinstance$ or $\phi\models \ntkflag$, we have $B \in \act_{\singleinstance} \cup \act_{\singletask}$.
    \end{enumerate}
\end{definition}
Intuitively, in an $\STK$-dominating $\AMASS$ $\Mm$, the task creation or task switching actions are all triggered by the $\singleinstance$ or $\singletask$ launch mode, more precisely,  
each task of $\Mm$ contains at most one $\STK$-activity, moreover, whenever a task creation or task switching action occurs, the launched activity is of $\singleinstance$ or $\singletask$ launch mode, equivalently speaking, 
whenever an $\standard$ or $\singletop$-activity is started, no task creation or task switching actions occur.  %This intuition is formalized by the proposition below.
%For the two sub-models of $\AMASS$, i.e., $\LMAMASS$ and $\IFAMASS$, an $\LMAMASS$ (resp. $\IFAMASS$) is said to be $\STK$-dominating if the above four constraints are satisfied.

\begin{example}
	We will use the following example to illustrate the concept of $\STK$-dominating $\AMASS$. \zhilin{the example to be cleaned}
	%, $\STK$-dominating $\IFAMASS$ and $\STK$-dominating $\AMASS$ respectively.

Let $\act = \{A, B, C, D, E\}$, $\lmd$ and $\aft$ be the launch-mode function and task-affinity function which defined in Table~\ref{tab-attribute-stk}.
Then $\Mm=(\act,A,\lmd,\aft,\Delta)$ is an $\STK$-dominating $\AMASS$, where $\Delta = \{\back,\tau_1, \tau_2, \tau_3, \tau_4, \tau_5, \tau_6\}$, where
		$\tau_1 = A \xrightarrow{\startactivity(\ntkflag)} C$,
		$\tau_2 = B \xrightarrow{\startactivity(\ntkflag)} E$,
		$\tau_3 = C \xrightarrow{\startactivity(\bot)} D$,
		$\tau_4 = C \xrightarrow{\startactivity(\bot)} C$,
		$\tau_5 = D \xrightarrow{\startactivity(\ctpflag)} B$,
		$\tau_6 = E \xrightarrow{\startactivity(\bot)} D$. 
Because $\back\in\Delta$, $\lmd(D) = \lmd(E) = \STK$ and $\aft(D) \neq \aft(E)$, and 
\begin{itemize}
	\item for $A \xrightarrow{\startactivity(\ntkflag)} C$, $\phi\models\ntkflag$ and $\lmd(C) = \SIT$,
	\item for $B \xrightarrow{\startactivity(\ntkflag)} E$, $\phi\models\ntkflag$ and $\lmd(E) = \STK$,
	\item for $C \xrightarrow{\startactivity(\bot)} D$, $\lmd(C) = \SIT$ and $\lmd(D) = \STK$,
	\item for $C \xrightarrow{\startactivity(\bot)} C$, $\lmd(C) = \SIT$,
	\item for $D \xrightarrow{\startactivity(\ctpflag)} B$, $\lmd(D) \neq \SIT$ and $\phi\models\neg\ntkflag$,
	\item for $E \xrightarrow{\startactivity(\bot)} D$, $\lmd(E) \neq \SIT$ and $\phi\models\neg\ntkflag$.
\end{itemize}

	Then the configurations that are reachable from the initial configuration $(([A_0], 0))$ by executing the transition rules from $\Delta$ are illustrated in Figure~\ref{stk-asm-example}, where the vertices denote the configurations and the edges denote the elements of $\xrightarrow[\Mm]{}$. 
	Note that for $\Mm$, there are only finitely many configurations reachable from the initial configuration, which may not be the case for $\STK$-dominating $\AMASS$ in general.  
	\begin{figure}
		% \vspace{-3mm}
			\centering
			\includegraphics[scale = 0.5]{stk-asm-example.pdf}
			\caption{Configurations reachable from the initial configuration $(([A_0], 0))$ in the $\STK$-dominating $\AMASS$ $\Mm$}
				%in $\phi$
		% \vspace{-6mm}	
		\label{stk-asm-example}
	\end{figure}

\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|c|c|c|c|c|c|}
	\hline
	Activity & $\lmd$ & $\aft$\\
	\hline
	$A$ & $\STD$ & 0\\
	\hline
	$B$ & $\STP$ & 1 \\
	\hline
	$C$ & $\SIT$ & 1 \\
	\hline
	$D$ & $\STK$ & 2 \\
	\hline
	$E$ & $\STK$ & 3 \\
	\hline
	\end{tabular}
	\caption{Attributes of activities}
	\label{tab-attribute-stk}
	\end{center}
\end{table} 


% example of STK-dominating AMASS here. \zhilin{three examples for $\LMAMASS$, $\IFAMASS$, and $\AMASS$ respectively, to be used in the decision procedure.}
\end{example}


\begin{proposition}\label{prop-stk}
    Let $\Mm=(\act,A_0,\lmd,\aft,\Delta)$ be an $\STK$-dominating $\AMASS$. Then each configuration $\rho$ that is reached from the initial configuration $(([A_0],\aft(A_0)))$ in $\Mm$ satisfies the following constraints:
    \begin{enumerate}
        \item for each $\STK$-activity $A\in\act$ with $\aft(A)\neq\aft(A_0)$, $A$ can only occur at the bottom of some task in $\rho$, 
        \item $\rho$ contains at most one $\standard/\singletop$-task, which, when it exists, has the same affinity as $A_0$.
		% \item $\SIT$ activity has the same effects with $\STK$ activity.
    \end{enumerate}
\end{proposition}

We are ready to state the main result of this paper. 

\begin{theorem}\label{thm:st-amass-reach}
The configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable.
\end{theorem}

The rest of this paper is devoted to the proof of Theorem~\ref{thm:st-amass-reach}. Since the decision procedure is involved, to ease the understanding, we present the decision procedure for $\singletask$-dominating $\LMAMASS$ first (Section~\ref{sec:reach-lmamass}), then $\singletask$-dominating $\IFAMASS$ (Section~\ref{sec:reach-ifamass}), and finally consider $\singletask$-dominating $\AMASS$ in its most general case (Section~\ref{sec:reach-amass}). 

For technical convenience, let us assume that \emph{the affinities of $\singleinstance$-activities are mutually distinct, moreover, they are different from those of the other activities}, that is, for each $A, B \in \act_\singleinstance$ with $A \neq B$, we have $\aft(A) \neq \aft(B)$, moreover, $\aft(\act_\singleinstance) \cap \aft(\act \setminus \act_\singleinstance) = \emptyset$. Note that this assumption is not a restriction, since regarding the task allocation mechanism, the affinities of $\singleinstance$-activities are redundant and independent of those of the other activities. With this assumption, the task allocation mechanism (formalized by $\gettsk(\rho, B)$) can be specified by the \emph{name function} $\namefun_B(\theta)$ defined in the sequel:  Let $\theta = \aname_1 \cdots \aname_k$ and $B \in \act$. Then $\namefun_B(\theta) = i$ if $\aft(B) = \aname_i$ for some $i \in [k]$, and $\namefun_B(\theta) = \bot$ otherwise. Note that the invariant of configurations, that is, the task affinities of every two non-$\singleinstance$ tasks are mutually distinct, guarantees the well-definedness of $\namefun_B(\theta)$.

%For simplicity, we assume that $\Mm$ contains $\standard$ and $\singletask$ activities only. 
%The proof of Theorem~\ref{thm:st-amass-reach} is technically the most challenging part of this paper. 
%To ease the understanding, we shall prove the configuration reachability problem of $\STK$-dominating $\LMAMASS$ (resp. $\STK$-dominating $\IFAMASS$) is decidable in Section~\ref{sec:reach-lmamass} (resp. Section~\ref{sec:reach-ifamass}) first, then prove the configuration reachability problem of $\STK$-dominating $\AMASS$ is decidable in Section~\ref{sec:reach-amass}.



\section{Configuration reachability problem of $\STK$-dominating $\LMAMASS$}\label{sec:reach-lmamass}
\input{reach-lmamass.tex}

\section{Configuration reachability problem of $\STK$-dominating $\IFAMASS$}\label{sec:reach-ifamass}
\input{reach-ifamass.tex}
% \subsection{Complete case}\label{sec:complete-case}


\section{Configuration reachability problem of $\STK$-dominating $\AMASS$}\label{sec:reach-amass}
\input{reach-amass.tex}